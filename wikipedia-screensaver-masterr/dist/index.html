<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
      <input type="checkbox" id="sound"><label class="settings" for="sound">ðŸ”ŠSound</label>
    <script src="js/app.js"></script>
  </body>
</html>

<script>
    ((doc, win, nav) => {
      'use strict';
    
      const SSE_URL = 'https://stream.wikimedia.org/v2/stream/recentchange';
      const soundCheckbox = doc.querySelector('#sound');
      const wakeLockCheckbox = doc.querySelector('#keep-awake');
      let voices = {};
      let wakeLockRequest = null;
    
      // Function to initialize or update voices
      const updateVoices = () => {
        voices = speechSynthesis.getVoices().reduce((acc, voice) => {
          acc[voice.lang.substr(0, 2)] = voice;
          return acc;
        }, {});
      };
    
      // Call once and set up event listener for changes
      updateVoices();
      speechSynthesis.onvoiceschanged = updateVoices;
    
      // Function to handle edits
      const handleEdit = (data) => {
        const language = data.wiki.replace('wiki', '');
        const voice = voices[language] || voices['en'];
        if (voice) {
          const utterance = new SpeechSynthesisUtterance(data.title);
          utterance.voice = voice;
          utterance.volume = soundCheckbox.checked ? 1 : 0;
          speechSynthesis.speak(utterance);
        }
      };
    
      // EventSource for streaming data
      const eventSource = new EventSource(SSE_URL);
      eventSource.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'edit' && !data.bot && data.namespace === 0 && data.wiki !== 'wikidatawiki') {
          handleEdit(data);
        }
      };
    
      // Event listener for sound checkbox
      soundCheckbox.addEventListener('click', () => {
        if (soundCheckbox.checked) {
          speechSynthesis.speak(new SpeechSynthesisUtterance('Sound is on'));
        }
      });
    
      // Wake lock management
      if (wakeLockCheckbox && 'wakeLock' in nav) {
        wakeLockCheckbox.addEventListener('click', async () => {
          if (wakeLockRequest) {
            wakeLockRequest.cancel();
            wakeLockRequest = null;
          } else {
            try {
              wakeLockRequest = await nav.wakeLock.request('screen');
            } catch (err) {
              console.error('Wake lock could not be activated:', err);
            }
          }
        });
      }
    })(document, window, navigator);
    </script>
    